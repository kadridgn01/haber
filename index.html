<script>
  // Eski SW'leri temizle (bir kere çalışır)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => {
      regs.forEach(r => {
        if (r.active && r.active.scriptURL.includes('blob:')) return; // yeni blob SW kalsın
        r.unregister();
      });
    });
  }

  // Yeni SW (blob)
  if ('serviceWorker' in navigator) {
    const swCode = `
      const CACHE='anlik-v3';                  // <-- sürüm artır
      const PRECACHE=['./'];

      self.addEventListener('install', e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(PRECACHE)));
        self.skipWaiting();
      });

      self.addEventListener('activate', e=>{
        e.waitUntil(
          caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))
        );
        self.clients.claim();
      });

      self.addEventListener('fetch', e=>{
        e.respondWith(
          caches.match(e.request).then(hit => hit || fetch(e.request).then(res=>{
            const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request, copy)); return res;
          }))
        );
      });
    `;
    const swBlob = new Blob([swCode], {type:'application/javascript'});
    const swURL = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL);

    // SW değişince sayfayı bir kez yenileyip yeni index'i göster
    navigator.serviceWorker.addEventListener('controllerchange', ()=>{
      if (!sessionStorage.getItem('reloadedOnce')) {
        sessionStorage.setItem('reloadedOnce','1');
        location.reload();
      }
    });
  }
</script>
